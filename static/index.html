<div>your id: <span id="self"></span></div>
<input id="cbox" type="checkbox" /> initializer?
<button id="start" onclick="startFn()">start</button>
<input id="to" />
<script src="adapter.js"> </script>
<script>
    const { start: startFn } = (function initialize() {
        class RTCPartner {
            constructor(idCb) {
                const wsUrl = new URL(document.location.toString());
                wsUrl.protocol = "ws";
                this.socket = new WebSocket(wsUrl);

                this.socket.addEventListener("open", () => {
                    this.socket.send(JSON.stringify({ op: "IDENTIFY" }));

                    const self = this;
                    this.socket.addEventListener("message", function identified({ data }) {
                        const { op, payload } = JSON.parse(data);
                        if (op === "IDENTIFY") {
                            if (idCb) {
                                idCb(payload);
                                self.ownId = payload;
                            }
                            self.socket.removeEventListener("message", identified);
                        }
                    });
                });
            }

            setPartner(partnerId) {
                if (this.partnerId === undefined)
                    this.partnerId = partnerId;
            }

            send(data) {
                if (this.ownId === undefined)
                    throw new Error("No connection to server available");
                if (this.partnerId === undefined)
                    throw new Error("No partner to send data to");

                this.socket.send(JSON.stringify({
                    op: "MESSAGE",
                    payload: {
                        from: this.ownId,
                        to: this.partnerId,
                        message: data
                    }
                }))
            }

            onReceive(cb) {
                this.socket.addEventListener("message", ({ data }) => {
                    const { op, payload } = JSON.parse(data);
                    console.log(payload)
                    if (op === "MESSAGE")
                        cb(payload);
                });
            }
        }

        const Partner = new RTCPartner((id) => document.getElementById("self").innerText = id);
        const configuration = { "iceServers": [{ "urls": "stun:stun.l.google.com:19302" }] }
        const peerConnection = new RTCPeerConnection(configuration);
        peerConnection.createDataChannel("asd");

        peerConnection.addEventListener("connectionstatechange", event => {
            if (peerConnection.connectionState === "connected")
                console.log("connected!");
        });

        peerConnection.addEventListener("icecandidate", event => {
            if (event.candidate)
                Partner.send({ iceCandidate: event.candidate });
        });

        async function start() {
            const checkbox = document.getElementById("cbox");

            if (checkbox.checked) {
                console.log("checked start");
                Partner.setPartner(document.getElementById("to").value);

                Partner.onReceive(async ({ message }) => {
                    if (message.answer)
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                    else if (message.iceCandidate)
                        await peerConnection.addIceCandidate(message.iceCandidate);
                });

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                Partner.send({ "offer": offer });
            } else {
                console.log("unchecked start");
                Partner.onReceive(async ({ from, message }) => {
                    Partner.setPartner(from);

                    if (message.offer) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));

                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        Partner.send({ 'answer': answer });
                    } else if (message.iceCandidate) {
                        await peerConnection.addIceCandidate(message.iceCandidate);
                    }
                });
            }
            return false;
        }

        return { start };
    })();
</script>